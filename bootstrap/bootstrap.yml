---
### File - bootstrap.yml
#   Prepare a Basic Lab Server
#   Created By:   Karl Vietmeier
#
###

- hosts: all
  remote_user: root

  # Variable Assignment
  vars:
   bin_dir: ~/bin
   temp_dir: ~/temp
   project_dir: ~/testing_output
   mirror: http://mirror.hmc.edu/fedora/linux/releases/22/Everything/x86_64/os/Packages
   # collectd vars
   cllctd_git: https://github.com/httpdss/collectd-web.git
   cllctd_install_dir: /usr/local
   cllctd_config_dir: /etc/collectd
   cllctd_conf: https://raw.githubusercontent.com/JoshHilliker/Telemetry-Infra/master/collectd.conf


  tasks:

  # Package Management
  - name: Add epel Repo
    # Always need this
    yum:
      name: epel-release
      state: present
    tags:
       - yum

  - name: Update CA Certs
    yum:
      name: ca-certificates
      state: latest
    tags:
       - yum

  - name: Upgrade all packages
    # "yum update -y"
    yum: name=* state=latest
    tags:
       - yum

  - name: install the 'Development tools' package group
    yum: name="@Development tools" state=present
    tags:
       - yum
       
  - name: Install Required Packages
    # Packages we all usually need
    yum:
      name:
        - psmisc
        - util-linux
        - coreutils
        - xfsprogs
        - e2fsprogs
        - findutils
        - git
        - wget
        - bzip2
        - kernel-devel
        - perf
        - blktrace
        - lsof
        - redhat-lsb
        - sysstat
        - python-yaml
        - ipmitool
        - dstat
        - zlib-devel
        - ntp
        - collectl
        - tree
        - screen
        - nvme-cli
        - iperf
    tags:
       - yum

  - name: Install collectd Packages
    # Need these for collectd telemetry
    yum:
      name:
        - collectd
        - collectd-rrdtool
        - rrdtool
        - rrdtool-devel
        - rrdtool-perl
        - perl-HTML-Parser
        - perl-JSON
        - perl-CGI-Session
    tags:
       - collectd

  # Setup some Project directories
  - name: Create Project Directory
    file: path={{ project_dir }} state=directory mode=755
    tags:
       - setupenv

  - name: Create Temp Directory
    file: path={{ temp_dir }} state=directory mode=755
    tags:
       - setupenv

  - name: Create bin Directory
    file: path={{ bin_dir }} state=directory mode=755
    tags:
       - setupenv

  # Configure basic services
  #- name: Enable firewalld
  #  service: name=firewalld state=started enabled=yes
  #  tags:
  #     - firewalld

  #- name: Configure firewalld
  #  firewalld:
  #    port: 9000/tcp
  #    state: enabled
  #  tags:
  #     - firewalld

  - name: Disable Services
    service: name={{ item }} state=stopped enabled=no
    with_items:
      - irqbalance
      - firewalld
    tags:
       - dservices

  - name: Enable Services
    service: name={{ item }} state=started enabled=yes
    with_items:
      - ntpd
    tags:
       - eservices


  # System Level tasks - update things like PCI IDs
  - name: Update PCI IDs
    command: update-pciids

   
  - name: Copy /etc/hosts
    copy:
      src: files/hosts
      dest: /etc/hosts
      owner: root
      group: root
      mode: 0644
      backup: yes
    tags:
       - hostfile

  # Minio Specific
  - name: Download Minio binary
    get_url:
      url: https://dl.minio.io/server/minio/release/linux-amd64/minio
      dest: "{{ bin_dir }}"
      mode: 0755
    tags:
       - minio

       
  - name: Set system tuning parameters
    sysctl:
      name: "{{ item.name }}"
      value: "{{ item.value }}"
      sysctl_file: /root/sysctl_test.conf
      state: present
      sysctl_set: yes
      reload: no
    with_items:
      - { name: 'kernel.pid_max', value: '4194303' }
      - { name: 'fs.file-max', value: '4194303' }
      - { name: 'vm.swappiness', value: '1' }
      - { name: 'vm.vfs_cache_pressure', value: '10' }
      - { name: 'net.core.rmem_max', value: '268435456' }
      - { name: 'net.core.wmem_max', value: '268435456' }
      - { name: 'net.core.rmem_default', value: '67108864' }
      - { name: 'net.core.wmem_default', value: '67108864' }
      - { name: 'net.core.netdev_budget', value: '1200' }
      - { name: 'net.core.optmem_max', value: '134217728' }
      - { name: 'net.ipv4.tcp_rmem', value: '67108864 134217728 268435456' }
      - { name: 'net.ipv4.tcp_wmem', value: '67108864 134217728 268435456' }
      - { name: 'net.ipv4.tcp_low_latency', value: '1' }
      - { name: 'net.ipv4.tcp_adv_win_scale', value: '1' }
      - { name: 'net.core.somaxconn', value: '65535' }
      - { name: 'net.core.netdev_max_backlog', value: '250000' }
      - { name: 'pv4.tcp_max_syn_backlog', value: '30000' }
      - { name: 'net.ipv4.tcp_max_tw_buckets', value: '2000000' }
      - { name: 'net.ipv4.tcp_tw_reuse', value: '1' }
      - { name: 'net.ipv4.tcp_tw_recycle', value: '1' }
      - { name: 'net.ipv4.tcp_fn_timeout', value: '5' }
      - { name: 'net.ipv4.udp_rmem_min', value: '8192' }
      - { name: 'net.ipv4.udp_wmem_min', value: '8192' }
      - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
      - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
      - { name: 'net.ipv4.conf.all.accept_source_route', value: '0' }
      - { name: 'net.ipv4.tcp_mtu_probing', value: '1' }
      - { name: 'vm.min_free_kbytes', value: '1000000' }
    tags: sysctl

### Scratch snippets below
  #- name: Copy the install logs into the temp folder
  #  copy:
  #    src: anaconda-ks.cfg
  #    dest: "{{ temp_dir }}"
  #    remote_src: yes
  #  tags:
  #     - system

  #  - name: Delete File
  #    file:
  #      path: anaconda-ks.cfg
  #      state: absent
  #    tags:
  #       - system

  #  - name: Copy the install logs into the temp folder
  #  copy:
  #      src: initial-setup-ks.cfg
  #      dest: "{{ temp_dir }}"
  #      remote_src: yes
  #    tags:
  #       - system

  #- name: Delete File
  #  file:
  #    path: initial-setup-ks.cfg
  #    state: absent
  #  tags:
  #     - system

  
